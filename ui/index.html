<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>你的朋友们</title>
</head>
<body>
    <div id="app" class="container-fluid">

        <div class="row">
            <div class="col">、<div class="jumbotron">
                <h1 class="display-4">友链管理</h1>
                <p class="lead">如果你的好友博客支持订阅，可以添加都这里，自动获取最新内容</p>
            </div>
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">网站名字</th>
                        <th scope="col">网站地址</th>
                        <th scope="col">订阅地址</th>
                        <th scope="col">最后更新时间</th>
                        <th scope="col">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="(item,index) in friends">
                        <th scope="row">{{item.ID}}</th>
                        <td>{{item.web_title}}</td>
                        <td>{{item.web_url}}</td>
                        <td>{{item.subscribe_url}}</td>
                        <td>{{item.last_update_time}}</td>
                        <td>
                            <button type="button" class="btn btn-primary" v-on:click="onUpdateFriend(index)" >更新</button>
                            <button type="button" class="btn btn-danger"  v-on:click="onDeleteFriend(index)" >删除</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-4">
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading">重要参数</h4>
                    <p>请输入后台的管理token</p>
                    <hr>
                    <input type="text" class="form-control" v-model="token" placeholder="管理Token">
                </div>

                <hr/>
                <div>
                    <h2>{{inputTitle}}</h2>
                    <div class="form-group">
                        <label for="web_url">网站地址</label>
                        <input :disabled="inputIsChange" type="text" class="form-control" id="web_url" aria-describedby="emailHelp" v-model="inputFriend.web_url">
                        <small id="emailHelp" class="form-text text-muted">https:// 或者 http:// 开头，新建后不能修改</small>
                    </div>
                    <div class="form-group">
                        <label for="subscribe_url">订阅地址</label>
                        <input type="text" class="form-control" id="subscribe_url" v-model="inputFriend.subscribe_url">
                    </div>
                    <div class="form-group">
                        <label for="web_title">网站名字</label>
                        <input type="text" class="form-control" id="web_title"  v-model="inputFriend.web_title">
                    </div>
                    <div class="form-group">
                        <label for="author_name">作者名字</label>
                        <input type="text" class="form-control" id="author_name" v-model="inputFriend.author_name">
                    </div>
                    <div class="form-group">
                        <label for="author_avatar">作者头像地址</label>
                        <input type="text" class="form-control" id="author_avatar" v-model="inputFriend.author_avatar">
                    </div>
                    <div class="form-group">
                        <label for="web_describe">网站描述</label>
                        <textarea class="form-control" id="web_describe" rows="3" v-model="inputFriend.web_describe"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" v-on:click="onSaveFriend">保存</button>
                </div>
            </div>
        </div>

    </div>


    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                token: '',
                friends: [],
                inputFriend: {
                    web_url: "",
                    web_title: "",
                    subscribe_url: "",
                    author_name: "",
                    author_avatar: "",
                    web_describe: ""
                },
                inputTitle: "添加朋友",
                inputIsChange: false,
                server_url: "http://127.0.0.1"
            },
            methods: {
                showMsg(msg){
                    alert(msg)
                },
                checkToken: function (){
                  if(this.token===""){
                      this.showMsg("请先输入管理Token")
                      return false
                  }
                  return true
                },
                // 保存
                onSaveFriend: function (){
                    if (!this.checkToken()){return}
                    let self = this
                    const response = fetch(this.server_url+"/friend?token="+this.token, {
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.inputFriend)
                    })
                    response.then(res => res.json())
                        .then(json=>{
                            if(json.message==="success"){
                                self.showMsg("添加成功")
                                self.friends.push(json.data)
                            }
                        })
                },
                onUpdateFriend: function(index){
                    if (!this.checkToken()){return}
                    this.inputFriend = this.friends[index]
                    this.inputTitle = "修改朋友信息"
                    this.inputIsChange = true
                },
                onDeleteFriend: function (index){
                    if (!this.checkToken()){return}
                    let friend = this.friends[index]
                    let self = this
                    const response = fetch(this.server_url+`/friend?token=${this.token}&id=${friend.ID}`, { method: "DELETE" })
                    response.then(res => res.json())
                        .then(json =>{
                            if(json.message==="success"){
                                self.showMsg("删除成功")
                                self.friends.splice(index)
                            }
                        })
                },

                // 获取全部朋友
                fetchFriends: function (){
                    console.log("获取朋友列表")
                    let self = this
                    const response = fetch(this.server_url+"/friend", { method: "GET" })
                    response.then(res => res.json())
                        .then(json =>{
                            self.friends = json.data
                        })
                },
            },
            mounted: function (){
                this.fetchFriends()
            }
        })
    </script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <style>

        #app{
            /*max-width: 90%;*/
            margin: 20px auto;
        }
    </style>

</body>
</html>